-- ============================================================================
-- Миграция: Добавление индексов для оптимизации производительности
-- Применяется к существующей базе данных для ускорения загрузки
-- ============================================================================
-- Выполнить: psql -d networking_app -f migrations/001_add_performance_indexes.sql
-- Или через pgAdmin / Neon Console

-- ============================================================================
-- ИНДЕКСЫ ДЛЯ ТАБЛИЦЫ PROFILES
-- ============================================================================

-- Индекс для сортировки по дате создания (DESC) - оптимизация из рекомендаций
CREATE INDEX IF NOT EXISTS idx_profiles_created_at_desc ON profiles(created_at DESC);

-- ============================================================================
-- ИНДЕКСЫ ДЛЯ ТАБЛИЦЫ SWIPES
-- ============================================================================

-- Индекс для сортировки по дате создания (DESC) - оптимизация из рекомендаций
CREATE INDEX IF NOT EXISTS idx_swipes_created_at_desc ON swipes(created_at DESC);

-- Дополнительный индекс для поиска входящих лайков (оптимизация)
CREATE INDEX IF NOT EXISTS idx_swipes_target_like_created ON swipes(target_profile_id, created_at DESC) WHERE action = 'like';

-- ============================================================================
-- ИНДЕКСЫ ДЛЯ ТАБЛИЦЫ MATCHES
-- ============================================================================

-- Индекс для сортировки по дате мэтча (DESC) - оптимизация из рекомендаций
CREATE INDEX IF NOT EXISTS idx_matches_matched_at_desc ON matches(matched_at DESC);

-- ============================================================================
-- ПРОВЕРКА СОЗДАННЫХ ИНДЕКСОВ
-- ============================================================================

-- Вывести список всех индексов для проверки
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename IN ('profiles', 'swipes', 'matches')
    AND indexname LIKE '%_desc' OR indexname LIKE '%_like_created'
ORDER BY tablename, indexname;

-- ============================================================================
-- КОНЕЦ МИГРАЦИИ
-- ============================================================================

